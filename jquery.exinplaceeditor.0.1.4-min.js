/*
 * 	exInPlaceEditor 0.1.4 - jQuery plugin
 *	written by Cyokodog	
 *
 *	Copyright (c) 2011 Cyokodog (http://d.hatena.ne.jp/cyokodog/)
 *	Dual licensed under the MIT (MIT-LICENSE.txt)
 *	and GPL (GPL-LICENSE.txt) licenses.
 *
 *	Built for jQuery library
 *	http://jquery.com
 *
 */
(function(b){var a=function(f){var f=b(f),e=f[0];for(var d in e){(function(g){if(b.isFunction(e[g])){f[g]=(/^get[^a-z]/.test(g))?function(){return e[g].apply(e,arguments)}:function(){var h=arguments;f.each(function(i){var j=f[i];j[g].apply(j,h)});return f}}})(d)}return f};var c=function(h,g){var e=h.is(":hidden");if(e){h.show()}var d=g.apply(h,[h]);if(e){h.hide()}return d};b.ex=b.ex||{};b.ex.inPlaceEditor=function(d,e,f){var h=this,i=h.config=b.extend({},b.ex.inPlaceEditor.defaults,f);i.targets=e;i.target=i.targets.eq(d);i.index=d;if(i.directEdit){i.editLabel=false}i.tag=i.target.attr("tagName");if(/INPUT|TEXTAREA/.test(i.tag)){i.isTextarea=(i.tag=="TEXTAREA");i.editor=i.target;var g=i.convertCR=="li"?"ul":i.directEdit?"a":"span";i.label=b("<"+g+"/>");if(g=="a"){i.label.attr("href","#")}i.editor.before(i.label);i.editor.val(h.getEditorValue(i.editor.val()));i.label.html(h.getConvertValue())}else{if(i.tag=="UL"){i.editorType="textarea";i.convertCR="li"}i.isTextarea=(i.editorType=="textarea");i.label=i.target;i.editor=b("<"+i.editorType+"/>");i.editor.val(h.getEditorValue(i.label.html()));if(i.label.find("*[tagName!="+i.convertCR+"]").size()){i.htmlEditor=true}i.label.html(h.getConvertValue());i.label.after(i.editor);if(i.displayStyle=="auto"&&!i.isTextarea){i.displayStyle=i.target.css("display")}}if(i.displayStyle=="auto"){i.displayStyle=i.isTextarea?"block":"inline"}if(i.displayStyle=="inline"||!i.isTextarea){i.convertCR="br"}i.displayClass="ex-ipe-"+i.displayStyle;i.editor.addClass("ex-ipe-editor");i.label.addClass("ex-ipe-label");i.editors=i.editor.wrap('<span class="'+i.displayClass+'"></span>').parent();if(i.saveLabel||i.cancelLabel){i.saveTool=b('<span class="ex-ipe-save-tool"/>');if(i.saveLabel){i.saveTool.append(i.saveButton=b('<a class="ex-ipe-save ex-ipe-btn" href="#">'+i.saveLabel+"</a>"))}if(i.cancelLabel){i.saveTool.append(i.cancelButton=b('<a class="ex-ipe-cancel ex-ipe-btn" href="#">'+i.cancelLabel+"</a>"))}i.editors.append(i.saveTool)}i.labels=i.label.wrap('<span class="'+i.displayClass+'"></span>').parent();h._moveMargin(i.label,i.labels);if(i.editLabel){i.editTool=b('<span class="ex-ipe-edit-tool" style="text-align:'+i.editLabelAlign+'"/>');i.editTool.append(i.editButton=b('<a class="ex-ipe-edit" href="#">'+i.editLabel+"</a>"));i.labels.append(i.editTool)}i.msgbox=b('<div class="ex-ipe-msgbox"/>').appendTo("body");if(i.directEdit){i.label.bind("click.ex-ipe mousedown.ex-ipe",function(){h.showEditor({focus:true});return false});if(i.hoverSpot){i.label.hover(function(){i.label.addClass("ex-ipe-spot");setTimeout(function(){i.label.removeClass("ex-ipe-spot")},500)})}}i.editor.bind("keydown.ex-ipe",function(j){if(j.keyCode==i.escKey){h.cancel({focus:true});return false}else{if(!i.isTextarea&&j.keyCode==i.saveKey){h.save({focus:true});return false}}});if(i.editButton){i.editButton.bind("click.ex-ipe",function(){h.showEditor({focus:true});return false}).hover(function(){i.label.addClass("ex-ipe-spot")},function(){i.label.removeClass("ex-ipe-spot")})}if(i.saveButton){i.saveButton.bind("click.ex-ipe",function(){h.save({focus:true});return false})}if(i.cancelButton){i.cancelButton.bind("click.ex-ipe",function(){h.cancel({focus:true});return false})}h.hideEditor();i.oninit(h,h)};b.extend(b.ex.inPlaceEditor.prototype,{_focus:function(d){var e=this,f=e.config;setTimeout(function(){d.focus();if(f.dataSelect){d.select()}},10)},_moveMargin:function(g,f){var d=this,e=d.config;b.each(["top","right","bottom","left"],function(h,i){f.css("margin-"+i,g.css("margin-"+i));g.css("margin-"+i,0)})},_convertElementToCR:function(e){var d=this,f=d.config;if(e.length&&f.isTextarea&&!(f.htmlEditor&&!f.htmlEditorAutoConvertCR)){if(f.convertCR=="br"){e=e.replace(/\<BR>\n|\<BR\/>\n/ig,"\n").replace(/\<BR>|\<BR\/>/ig,"\n")}else{if(f.convertCR=="p"){e=e.replace(/\<BR>\n|\<BR\/>\n/ig,"\n").replace(/\<P>/ig,"").replace(/\<\/P>/ig,"\n")}else{if(f.convertCR=="li"){e=e.replace(/<LI>|<\/LI>/ig,"")}}}}return e},_convertCRToElement:function(e){var d=this,f=d.config;if(e.length&&f.isTextarea&&!(f.htmlEditor&&!f.htmlEditorAutoConvertCR)){if(f.convertCR=="br"){e=e.replace(/\n/g,"<br/>");if(f.htmlEditorAutoConvertCR){e=e.replace(/><br\/></g,"><")}}else{if(f.convertCR=="p"){e="<p>"+e.replace(/\n/g,"</p><p>")+"</p>"}else{if(f.convertCR=="li"){if(f.directEdit&&f.directEditLiLink){e='<li><a href="#">'+e.replace(/\n/g,'</a></li><li><a href="#">')+"</a></li>"}else{e="<li>"+e.replace(/\n/g,"</li><li>")+"</li>"}}}}}return e},getTarget:function(){return this.config.target},getEditor:function(){return this.config.editor},getLabel:function(){return this.config.label},getValue:function(){var d=this,e=d.config;return d.trimText(e.editor.val())},getConvertValue:function(){var e=this,f=e.config;var d=e.getValue();if(!f.htmlEditor){d=e.escHTML(d)}if(f.htmlEditorAutoConvertCR){d=e._convertCRToElement(d)}return d==""?f.nulltext:d},getEditorValue:function(e){var d=this,f=d.config;var e=arguments.length?e:d.getValue();e=d._convertElementToCR(e);return e==f.nulltext?"":e},showEditor:function(f){var e=this,h=e.config,d=f||{};h._prevValue=e.getValue();h.labels.hide();var g=function(){!d.callback||d.callback.apply(e,[e]);!d.focus||e._focus(h.editor)};if(h.effect&&h.displayStyle=="block"){h.editors.show(h.effect,g)}else{h.editors.show();g()}return e},hideEditor:function(f){var e=this,h=e.config,d=f||{};h.editors.hide();var g=function(){!d.callback||d.callback.apply(e,[e]);!d.focus||e._focus(h.label)};if(h.effect&&h.displayStyle=="block"){h.labels.show(h.effect,g)}else{h.labels.show();g()}return e},cancel:function(f){var e=this,g=e.config,d=f||{};if(g._prevValue!=undefined){g.editor.val(g._prevValue)}e.hideEditor(d);return e},save:function(f){var e=this,g=e.config,d=f||{};if(/undefined|true/.test(g.onsave.call(e,e))){e.commit(d)}return e},commit:function(f){var e=this,g=e.config,d=f||{};g.editor.val(e.getValue());g.label.html(e.getConvertValue());e.hideEditor(d);return e},trimText:function(d){return d.replace(/^\n+|\n+$/g,"").replace(/^\s+|\s+$/g,"")},escHTML:function(d){return d.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},showMessage:function(g,h){var f=this,i=f.config,d=b.extend({hideTime:3000,callback:null,closeButton:false,className:"",showMethod:"slideDown"},h);var j,l,e;c(i.editor,function(m){j=m.offset();l=m.outerHeight();e=m.outerWidth()});i.msgbox[0].className="ex-ipe-msgbox "+d.className;i.msgbox.css(i.displayStyle=="block"?{top:j.top+l,left:j.left}:{top:j.top,left:j.left+e}).html("<span>"+g+"</span>");var k;if(d.closeButton){b('<a href="#" class="ex-ipe-err-close">'+d.closeButton+"</a>").appendTo(i.msgbox).click(function(){if(k){clearTimeout(k)}f.hideMessage(d);return false})}i.msgbox.hide()[d.showMethod]();if(d.hideTime){k=setTimeout(function(){f.hideMessage(d)},d.hideTime)}return f},hideMessage:function(f){var e=this,g=e.config,d=b.extend({callback:null,hideMethod:"slideUp"},f);g.msgbox[d.hideMethod]();if(d.callback){d.callback()}return e},saving:function(e){var d=this,f=d.config;f.editor.attr("disabled",true);f.saveTool.css("visibility","hidden");d.showMessage(e||f.savingMessage,{className:"ex-ipe-saving",showMethod:"show",hideTime:false});return d},saveComplete:function(){var d=this,e=d.config;d.hideMessage({hideMethod:"hide",callback:function(){e.editor.attr("disabled",false);e.saveTool.css("visibility","visible");d.commit()}});return d},saveError:function(e){var d=this,f=d.config;f.editor.attr("disabled",false);f.editor.focus();f.saveTool.css("visibility","hidden");d.showMessage(e||"error!",{closeButton:"OK",className:"ex-ipe-err",callback:function(){f.saveTool.css("visibility","visible")}});return d}});b.ex.inPlaceEditor.defaults={editorType:"input",htmlEditor:false,htmlEditorAutoConvertCR:true,displayStyle:"auto",saveLabel:"SAVE",cancelLabel:"CANCEL",directEdit:true,directEditLiLink:true,editLabel:"EDIT",editLabelAlign:"left",saveKey:13,escKey:27,convertCR:"br",nulltext:"(none)",savingMessage:"Saving...",hoverSpot:true,nowHover:false,dataSelect:false,effect:"fast",oninit:function(){},onsave:function(){}};b.fn.exInPlaceEditor=function(f){var d=this,e=[];d.each(function(g){var i=d.eq(g);var h=i.data("ex-in-place-editor")||new b.ex.inPlaceEditor(g,d,f);e.push(h);i.data("ex-in-place-editor",h)});return f&&f.api?a(e):d}})(jQuery);